<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  {% load static %}
  <link rel="stylesheet" href="{% static 'compute_style.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <title>Document</title>
</head>

<body>
  <div class="nav-bar">
    <h1>Tomato Disease Detection</h1>
  </div>
  <div class="compute">
    <div class="input">
      <img src="{% static 'img/tomato.png' %}" alt="Background Image" style="
        position: absolute;
        width: 70%;
        height: 70%;
        left: 0;
        bottom: 0;
        opacity: 0.3;
      " />
      <form id="upload-form" action="{% url 'predict' %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div id="camera-container" style="display: none;">
          <video id="video" autoplay></video>
          <button type="button" class="btn" id="capture-btn" style="width: 100px;  text-align: center;"
            onclick="captureImage()">ถ่ายภาพ</button>
        </div>
        <label for="file-input" class="btn" id="file-input-label" style="width: 100px;  text-align: center; left: 50%;
     transform: translateX(175%);">รูปภาพ</label>
        <p style="font-size: 14px; color: #555; margin-top: 5px; margin-bottom: 20px; text-align: center; position: relative; background-color: rgba(255, 255, 255, 0.65);
        padding: 5px; /* Add some padding around the text */
        border-radius: 3px; /* Optional: rounded corners for the background */" id="file-input-label-advice">
          คลิกเพื่อเลือกภาพใบมะเขือเทศจากอุปกรณ์ของคุณ, เฉพาะไฟล์นามสกุล .jpg, .jpeg, .png</p>
        <input type="file" id="file-input" name="file" accept="image/*" onchange="previewImage(event)">
        <button type="button" class="btn" id="capture-image-btn" style="width: 100px;  text-align: center; left: 50%;
     transform: translateX(175%);" onclick="startCamera()">กล้อง</button>
        <p style="font-size: 14px; color: #555; margin-top: 5px; text-align: center; width: 150px; word-wrap: break-word; transform: translateX(100%); position: relative; background-color: rgba(255, 255, 255, 0.65);
        padding: 5px; /* Add some padding around the text */
        border-radius: 3px; /* Optional: rounded corners for the background */" id="capture-image-btn-advice">
          คลิกเพื่อเปิดกล้อง</p>
        <!-- <button type="submit" class="btn" id="upload-btn" style="width: 150px; display: none;" disabled>Upload Image</button> -->
      </form>
    </div>

    <div class="icon-wrapper" style="display: none;">
      <div class="icon-container">
        <i class="fa-solid fa-arrow-right-arrow-left"></i>
      </div>
    </div>

    <div class="output-wrapper" style="display: none;">
      <div class="output hidden" id="output-section">
        <img id="preview" src="" alt="" class="hidden">
        <div class="prediction-result">
          {% if predicted_class %}
          <p><strong>Predicted:</strong> {{ predicted_class }}</p>
          <!-- <p><strong>Confidence:</strong> {{ prediction_confidence }}%</p> -->
          <img id="result_image" src="data:image/jpeg;base64,{{ image_base64 }}" alt="Uploaded Image" />
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Pop-up Box -->
    <div id="popup-box" class="popup-box" style="display: none;">
      <div class="popup-content">
        <span class="popup-close" onclick="closePopup()">&times;</span>
        <div id="popup-text"></div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer style="background-color: #f1f1f1; padding: 10px; text-align: center;">
    <p>&copy; 2024 Tomato Disease Detection. All rights reserved.</p>
  </footer>

  <script>
    const video = document.getElementById('video');
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    const preview = document.getElementById('preview');
    const fileInput = document.getElementById('file-input');
    const cameraContainer = document.getElementById('camera-container');
    const captureImageBtn = document.getElementById('capture-image-btn');
    const fileInputLabel = document.getElementById('file-input-label');
    const fileInputLabelAdvice = document.getElementById('file-input-label-advice');
    const captureImageBtnAdvice = document.getElementById('capture-image-btn-advice');
    const uploadForm = document.getElementById('upload-form');
    let currentStream = null;

    function startCamera() {
      fileInputLabel.style.display = 'none';
      captureImageBtn.style.display = 'none';
      fileInputLabelAdvice.style.display = 'none'; // Hide file input advice
      captureImageBtnAdvice.style.display = 'none'; // Hide camera button advice

      cameraContainer.style.display = 'block';

      navigator.mediaDevices.enumerateDevices()
        .then(devices => {
          const videoDevices = devices.filter(device => device.kind === 'videoinput');
          if (videoDevices.length > 0) {
            startVideo(videoDevices[0].deviceId);
          } else {
            alert("No camera devices found.");
          }
        })
        .catch(err => {
          console.error("Error enumerating devices: ", err);
          alert("Error enumerating devices: " + err.message);
        });
    }

    function startVideo(deviceId) {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }

      const constraints = {
        video: {
          deviceId: deviceId ? {
            exact: deviceId
          } : undefined
        }
      };

      navigator.mediaDevices.getUserMedia(constraints)
        .then(stream => {
          video.srcObject = stream;
          video.play(); // Ensure the video is playing
          currentStream = stream;
        })
        .catch(err => {
          console.error("Error accessing camera: ", err);
          alert("Error accessing camera: " + err.message);
        });
    }

    function captureImage() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(blob => {
        const file = new File([blob], "captured_image.jpg", {
          type: "image/jpeg"
        });
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;
        preview.src = URL.createObjectURL(blob);
        preview.style.display = 'block';
        cameraContainer.style.display = 'none';
        fileInputLabel.style.display = 'block';
        captureImageBtn.style.display = 'block';

        uploadForm.submit();
        document.querySelector('.prediction-result').innerHTML = '';
      }, "image/jpeg");
    }

    function previewImage(event) {
      const reader = new FileReader();
      reader.onload = function () {
        preview.src = reader.result;
        preview.classList.remove('hidden');
        cameraContainer.classList.add('hidden');
        fileInputLabel.classList.remove('hidden');
        captureImageBtn.classList.remove('hidden');

        document.getElementById('output-section').classList.remove('hidden');
        document.querySelector('.icon-container').classList.remove('hidden');

        uploadForm.submit();
        document.querySelector('.prediction-result').innerHTML = '';
      }
      reader.readAsDataURL(event.target.files[0]);
    }

    function showPopup(predictedClass) {
      let advice;
      switch (predictedClass) {
        case 'โรคใบจุดมะเขือเทศ':
          advice = 'Advice for โรคใบจุดมะเขือเทศ...';
          break;
        case 'โรคใบไหม้':
          advice = 'Advice for โรคใบไหม้...';
          break;
        case 'โรคใบจุดวงกลม':
          advice = 'Advice for โรคใบจุดวงกลม...';
          break;
        case 'ใบสุขภาพดี':
          advice = 'Advice for ใบสุขภาพดี...';
          break;
        default:
          advice = 'No advice available.';
      }
      document.getElementById('popup-text').innerHTML = advice;
      document.getElementById('popup-box').classList.remove('hidden');
    }

    function closePopup() {
      document.getElementById('popup-box').classList.add('hidden');
    }

    function inspectPopup() {
      document.getElementById('popup-box').classList.remove('hidden');
    }

    document.addEventListener('DOMContentLoaded', function () {
      const iconWrapper = document.querySelector('.icon-wrapper');
      const outputWrapper = document.querySelector('.output-wrapper');
      const fileInp = document.getElementById('file-input');
      const predictedClass = "{{ predicted_class|escapejs }}";

      outputWrapper.style.display = 'none';
      iconWrapper.style.display = 'none';

      if (predictedClass) {
        outputWrapper.style.display = 'block';
        iconWrapper.style.display = 'block';
        fileInputLabelAdvice.style.display = 'block';
        captureImageBtnAdvice.style.display = 'block';
      }

      fileInp.addEventListener('change', function () {
        outputWrapper.style.display = 'block';
        iconWrapper.style.display = 'block';
        fileInputLabelAdvice.style.display = 'block';
        captureImageBtnAdvice.style.display = 'block';
      });
    });
  </script>
</body>

</html>